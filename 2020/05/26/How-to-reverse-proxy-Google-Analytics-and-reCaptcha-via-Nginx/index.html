<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><title> How to reverse proxy Google Analytics and reCaptcha via Nginx · xiaopc</title><meta name="description" content="How to reverse proxy Google Analytics and reCaptcha via Nginx - xiaopc"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/blog-en/favicon.ico"><link rel="stylesheet" href="/blog-en/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://xiaopc.org/blog-en/atom.xml" title="xiaopc"><meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/blog-en/atom.xml" title="xiaopc" type="application/atom+xml">
</head><body><div class="wrap"><header><a class="logo-link" href="/blog-en/"><img src="/blog-en/logo.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a class="nav-list-link" href="/blog-en/archives/" target="_self">archives</a></li><li class="nav-list-item"><a class="nav-list-link" href="/blog-en/links/" target="_self">links</a></li><li class="nav-list-item"><a class="nav-list-link" href="https://xpc.im/" target="_blank">about</a></li><li class="nav-list-item"><a class="nav-list-link" href="/blog-en/atom.xml" target="_self">rss</a></li><li class="nav-list-item"><a class="nav-list-link" href="https://xiaopc.org/" target="_blank">cn</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">How to reverse proxy Google Analytics and reCaptcha via Nginx</h1><div class="post-info">May 26, 2020 · <a href="/blog-en/categories/backend/">backend</a></div><div class="post-content"><p><em>original post date: July 18, 2016</em></p>
<blockquote>
<p>2018/3/11 update</p>
<p>There are a lot of problems with this approach (lack of access to real IP, etc.) , and given the improved availability of Google Analytics services in China, it is no longer recommended. If reliability is sought, it is recommended to use domestic services or self-built statistical services.</p>
</blockquote>
<p>You can find nginx.conf for reversing proxy Google Analytics on Google, but most of them are for the old version. And so do reCaptcha's. After solving some issues, here's my code.</p>
<span id="more"></span>
<p>Attention: 1. <code>ngx_http_substitutions_filter_module module</code> needed。 2. DO NOT ADD <code>X-Frame-Options DENY</code> WHILE CONFIGURING SSL (<code>SOMEORIGIN</code> would be fine for self using, not tested) 3. After reverse proxy reCaptcha, challenge will be difficult. (Using proxies will reduce credibility, and some code uses complex obfuscations that result in client-side identification code can't be modified)</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># reCaptcha reverse proxy</span></span><br><span class="line"> <span class="section">location</span> /recaptcha &#123;</span><br><span class="line">     <span class="attribute">default_type</span> text/html;</span><br><span class="line">     <span class="attribute">subs_filter_types</span> text/css text/xml text/javascript;</span><br><span class="line">     <span class="attribute">subs_filter</span> <span class="string">&#x27;www.gstatic.com&#x27;</span> <span class="string">&#x27;lab.xpc.im/wwwgstatic&#x27;</span> g;</span><br><span class="line">     <span class="attribute">proxy_set_header</span> X-real-ip <span class="variable">$remote_addr</span>;</span><br><span class="line">     <span class="attribute">proxy_pass</span> https://www.google.com/recaptcha;</span><br><span class="line">     <span class="attribute">proxy_set_header</span> Accept-Encoding <span class="string">&quot;&quot;</span>; <span class="comment">#see [3]</span></span><br><span class="line">     <span class="attribute">proxy_set_header</span> User-Agent <span class="variable">$http_user_agent</span>;</span><br><span class="line">     break;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="section">location</span> /wwwgstatic &#123;</span><br><span class="line">     <span class="attribute">subs_filter_types</span> text/css text/xml text/javascript;</span><br><span class="line">     <span class="attribute">subs_filter</span> <span class="string">&#x27;www.gstatic.com&#x27;</span> <span class="string">&#x27;lab.xpc.im/wwwgstatic&#x27;</span> g;</span><br><span class="line">     <span class="attribute">subs_filter</span> <span class="string">&#x27;www.google.com/recaptcha&#x27;</span> <span class="string">&#x27;lab.xpc.im/recaptcha&#x27;</span> g;</span><br><span class="line">     <span class="attribute">subs_filter</span> <span class="string">&#x27;ssl.gstatic.com&#x27;</span> <span class="string">&#x27;lab.xpc.im/sslgstatic&#x27;</span> g;</span><br><span class="line">     <span class="attribute">proxy_set_header</span> X-real-ip <span class="variable">$remote_addr</span>;</span><br><span class="line">     <span class="attribute">proxy_pass</span> https://www.gstatic.com/;</span><br><span class="line">     <span class="attribute">proxy_set_header</span> Accept-Encoding <span class="string">&quot;&quot;</span>;</span><br><span class="line">     <span class="attribute">proxy_set_header</span> User-Agent <span class="variable">$http_user_agent</span>;</span><br><span class="line">     break;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="section">location</span> /sslgstatic &#123;</span><br><span class="line">     <span class="attribute">subs_filter_types</span> text/css text/xml text/javascript;</span><br><span class="line">     <span class="attribute">subs_filter</span> <span class="string">&#x27;www.gstatic.com&#x27;</span> <span class="string">&#x27;lab.xpc.im/wwwgstatic&#x27;</span> g;</span><br><span class="line">     <span class="attribute">subs_filter</span> <span class="string">&#x27;www.google.com/recaptcha&#x27;</span> <span class="string">&#x27;lab.xpc.im/recaptcha&#x27;</span> g;</span><br><span class="line">     <span class="attribute">proxy_set_header</span> X-real-ip <span class="variable">$remote_addr</span>;</span><br><span class="line">     <span class="attribute">proxy_pass</span> https://ssl.gstatic.com/;</span><br><span class="line">     <span class="attribute">proxy_set_header</span> Accept-Encoding <span class="string">&quot;&quot;</span>;</span><br><span class="line">     <span class="attribute">proxy_set_header</span> User-Agent <span class="variable">$http_user_agent</span>;</span><br><span class="line">     break;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Google Analytics reverse proxy</span></span><br><span class="line"> <span class="section">location</span> /ga &#123;</span><br><span class="line">     <span class="attribute">proxy_set_header</span> X-real-ip <span class="variable">$remote_addr</span>;</span><br><span class="line">     <span class="attribute">rewrite</span><span class="regexp"> ^/ga/(.*)$</span> /<span class="variable">$1</span>?<span class="variable">$args</span>&amp;amp;uip=$remote_addr;</span><br><span class="line">     <span class="attribute">proxy_pass</span> https://www.google-analytics.com;</span><br><span class="line">     <span class="attribute">proxy_set_header</span> User-Agent <span class="variable">$http_user_agent</span>;</span><br><span class="line">     break;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="section">location</span> /analytics &#123;</span><br><span class="line">     <span class="attribute">proxy_set_header</span> X-real-ip <span class="variable">$remote_addr</span>;</span><br><span class="line">     <span class="attribute">rewrite</span><span class="regexp"> ^/ga/(.*)$</span> /<span class="variable">$1</span>?<span class="variable">$args</span>&amp;amp;uip=$remote_addr;</span><br><span class="line">     <span class="attribute">proxy_pass</span> https://www.google.com;</span><br><span class="line">     <span class="attribute">proxy_set_header</span> User-Agent <span class="variable">$http_user_agent</span>;</span><br><span class="line">     break;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="section">location</span> /analytics.js &#123;</span><br><span class="line">     <span class="attribute">default_type</span> text/html;</span><br><span class="line">     <span class="attribute">subs_filter_types</span> text/css text/xml text/javascript;</span><br><span class="line">     <span class="attribute">subs_filter</span> <span class="string">&#x27;www.google-analytics.com&#x27;</span> <span class="string">&#x27;lab.xpc.im/ga&#x27;</span> g;</span><br><span class="line">     <span class="attribute">subs_filter</span> <span class="string">&#x27;www.google.com/analytics&#x27;</span> <span class="string">&#x27;lab.xpc.im/analytics&#x27;</span> g;</span><br><span class="line">     <span class="attribute">proxy_set_header</span> X-real-ip <span class="variable">$remote_addr</span>;</span><br><span class="line">     <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">     <span class="attribute">proxy_set_header</span> Referer https://www.google-analytics.com;</span><br><span class="line">     <span class="attribute">proxy_set_header</span> Host www.google-analytics.com;</span><br><span class="line">     <span class="attribute">proxy_pass</span> https://www.google-analytics.com;</span><br><span class="line">     <span class="attribute">proxy_set_header</span> Accept-Encoding <span class="string">&quot;&quot;</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<hr />
<p>References:</p>
<p>[1] https://ruby-china.org/topics/27400</p>
<p>[2] https://rocfang.gitbooks.io/dev-notes/content/guan_yu_proxy_pass_de_can_shu_lu_jing_wen_ti.html</p>
<p>[3] https://www.v2ex.com/t/234923</p>
</div><div class="post-footer"><p class="license"><b>This work is licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA 4.0</a>. You are free to:</b><br>
Copy and redistribute the material;<br>
Remix, transform and build upon the material.<br>
<b>Under the following terms:</b><br>
Give appropriate credit and provide a link to this page;<br>
Distribute your contributions under the same license.</p></div></article></div></main><footer><div class="paginator"><a class="prev" href="/blog-en/2020/05/27/Speaking-of-httpoxy/">prev</a><a class="next" href="/blog-en/2020/05/25/Hello-There/">next</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'xiaopc-1';
var disqus_identifier = '2020/05/26/How-to-reverse-proxy-Google-Analytics-and-reCaptcha-via-Nginx/';
var disqus_title = 'How to reverse proxy Google Analytics and reCaptcha via Nginx';
var disqus_url = 'https://xiaopc.org/blog-en/2020/05/26/How-to-reverse-proxy-Google-Analytics-and-reCaptcha-via-Nginx/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//#{theme.disqus}.disqus.com/count.js" async></script><div class="copyright"><p>© 2023 <a href="https://xiaopc.org/blog-en">xiaopc</a>, <a href="https://hexo.io/" target="_blank">hexo</a> & <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdnjs.loli.net/ajax/libs/mathjax/2.7.2-rc/MathJax.js?config=TeX-AMS-MML_HTMLorMML" crossorigin="anonymous"></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-KNHBVTCZSN"></script><script>window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', "G-KNHBVTCZSN");</script></body></html>